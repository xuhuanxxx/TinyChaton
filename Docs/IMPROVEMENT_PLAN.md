# TinyChaton 改进实施计划 (Improvement Plan)

基于 `Docs/TODO.md` 中的待办事项，本文档制定了分阶段的实施计划，旨在有序提升插件的代码质量、性能和可维护性。

---

## 📅 第一阶段：快速赢取与代码规范 (Quick Wins & Hygiene)
**目标**: 统一代码风格，消除低级噪音，为后续重构打好基础。
**预计周期**: 1周

### 1. 自动化代码格式化 (TODO-003)
- **行动**: 配置 `.editorconfig` 和 VSCode 设置，统一行尾空白处理。
- **工具**: 使用 `sed` 批量清理现有文件。
- **收益**: 立即消除 diff 中的空白干扰，提升代码整洁度。

### 2. 统一命名与注释规范 (TODO-001, TODO-002)
- **行动**: 
    - 确立 `localVariableName` (小写驼峰) 和 `CONSTANT_NAME` (大写下划线) 规范。
    - 逐步修正现有文件中的命名不一致。
    - 统一函数文档注释为 LuaCATS 风格 (`---@param`)。
- **收益**: 提升代码可读性，降低认知负荷。

### 3. API 文档注解 (TODO-010)
- **行动**: 为核心类 `ChatData` 和关键 API 添加 LuaCATS 注解。
- **收益**: 启用 IDE (如 VSCode + Lua) 的智能提示和类型检查，减少开发错误。

---

## ⚡ 第二阶段：核心性能与稳定性 (Core Stability & Performance)
**目标**: 解决已知的性能瓶颈，建立测试机制，确保插件运行稳定高效。
**预计周期**: 2-3周

### 1. 构建频道反向索引 (TODO-006) 🚀 **高优先级**
- **行动**: 在 `Modules/Utils.lua` 中实现 `BuildChannelIndex`，将频道查找从 O(n) 优化为 O(1)。
- **收益**: 直接提升高频消息处理时的性能。

### 2. 建立单元测试框架 (TODO-007)
- **行动**: 创建 `Core/Tests.lua`，并为 `Utils` 模块编写基础测试用例（如 `DeepCopy`, `NormalizeChannelBaseName`）。
- **收益**: 确保核心工具函数的正确性，为重构提供安全网。

### 3. 引入性能剖析工具 (TODO-008)
- **行动**: 实现简易的 `Profiler` 模块，监控 `ChatData:New` 和 `Blacklist` 等热点函数。
- **收益**: 用数据驱动优化，避免盲目猜测。

---

## 🛠️ 第三阶段：重构与架构治理 (Refactoring & Architecture)
**目标**: 优化代码结构，降低模块耦合，提升可维护性。
**预计周期**: 3-4周

### 1. 拆分巨型函数 (TODO-011)
- **行动**: 重构 `Modules/SnapshotManager.lua` 中的 `RestoreChannelContent` 函数，将其拆分为职能单一的子函数。
- **收益**: 提升代码可读性和可测试性。

### 2. 提取公共 UI 组件 (TODO-012)
- **行动**: 将分散在 Shelf 和 Dialog 中的按钮创建逻辑提取到 `Libs/UI/Button.lua`。
- **收益**: 减少重复代码，统一 UI 风格。

### 3. 编写架构文档 (TODO-009)
- **行动**: 撰写 `Docs/ARCHITECTURE.md`，图解数据流向、模块注册机制和配置结构。
- **收益**: 帮助新贡献者快速理解项目全貌，降低维护门槛。

---

## 🚀 第四阶段：高级优化 (Advanced Optimization)
**目标**: 针对特定场景进行极致优化，提升用户体验。
**预计周期**: 待定 (按需进行)

### 1. 字符串拼接优化 (TODO-004)
- **行动**: 在高频热点（如消息拼接）使用 `table.concat` 或 `string.format` 替代 `..`。
- **前提**: 需配合 Profiler 确认性能瓶颈后再实施。

### 2. 对象池模式 (TODO-013)
- **行动**: 对 `ChatData` 等高频创建销毁的对象实现复用池。
- **前提**: 仅在 Lua GC 造成明显卡顿或内存压力大时实施。

### 3. 配置热重载 (TODO-014)
- **行动**: 实现配置监听机制，使得修改设置后无需重载界面即可生效。
- **收益**: 显著提升用户配置体验。

---

## 📈 执行建议

1. **小步快跑**: 每个 TODO 作为一个独立的 PR 或 Commit 提交，避免一次不仅修改过多。
2. **测试先行**: 在进行重构（如拆分函数）前，尽量先补齐相关测试用例。
3. **持续文档**: 代码变动时同步更新注释和文档。
