# AGENT.md - TinyChaton 全局开发约束

本文档用于指导 AI 在本项目中的改动行为。目标是提供长期稳定的高层规则，避免被短期实现细节误导。

## 1. 目标与边界

- TinyChaton 是轻量聊天增强插件，优先保证聊天体验稳定、可预期、可回退。
- 不引入与聊天主链路无关的复杂能力，不做“全能型 UI 框架”。
- 优先复用现有能力和注册表，不随意新增平行机制。

## 2. 架构不变量

- 策略能力驱动：功能启停由能力与模式决定，而不是由模块各自分散判断环境。
- 生命周期可撤销：所有可动态启停功能必须可 `enable/disable`，并可完整 teardown。
- 数据驱动优先：频道/动作等定义以注册表为源，不写散落硬编码映射。
- 入口收口优先：入站聊天、显示变换、出站发送应走统一入口（网关/核心入口）再分发。

## 3. 安全与行为语义

- 对聊天数据做防御性处理：涉及消息文本时必须先处理非字符串/受保护值场景。
- 不把 combat 状态当作能力开关的主依据；能力判定以策略层为准。
- 区分“手动动作”与“自动动作”：
  - 手动频道动作（如 Shelf 触发的发送入口、加入/离开频道）应可用。
  - 自动化动作（自动欢迎、自动加入、后台发送）受策略能力约束。
- 任何破坏玩家显式操作预期的改动都视为高风险回归。

## 4. 变更准则

- 先加守卫与可观测性，再做行为改动。
- 优先做可逆改动：保留回滚路径，避免一次性重写关键链路。
- 避免隐式全局副作用（全局变量覆盖、不可恢复 hook、难追踪状态写入）。
- 修改时同步更新必要文档，但只记录稳定原则，不记录易过时细节。

## 5. 最小工程规范

- `local` 优先，避免意外全局变量。
- 命名清晰一致：常量大写下划线，公开 API 用 `addon:Method()` 风格。
- 高频路径注意性能：避免不必要分配、重复闭包与重复查找。
- 提交前至少做 Lua 语法检查：`luac -p <file.lua>` 或批量检查。
